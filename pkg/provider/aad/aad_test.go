package aad

import (
	"encoding/json"
	"github.com/sirupsen/logrus"
	"testing"
)

func TestAad_UnmarshallMfaResponseWithEntropy(t *testing.T) {

	mfaBeginJsonWithEntropy := []byte("{\"Success\":true,\"ResultValue\":\"Success\",\"Message\":null,\"AuthMethodId\":\"PhoneAppNotification\",\"ErrCode\":0,\"Retry\":false,\"FlowToken\":\"AQABAAEAAAD--DLA3VO7QrddgJg7Wevr5BtzS6C3muY2iOn2W5Nxhyz_B2nFLqOhdxngHgZWDXZHBx6mK27MN6N26J1oz7ydOnsuY3EfEWr5SHToI1N-NpdxotuKfqh6ssxejlKzEaCeYZ1AymWu3DENP9TEo0Pxnd6Vbd7H7soUMjW2-m2ykU1R7bCqcIQiGCF9NX2wmRVm5ia2SzPy1J3rU9nAKnppmiJoyT0yP-U24Jsty7Dje52s-ddFHkjtupiV-R3_JMx4c2KDAfJYabwAWy1Ra1UsxZbSwMkRwhacS46Y9pmztFuSeF6_opIV2H6xNogk2usNnFqJLqT-ibgy2qkJvot07XGH0leN7n-C2oLnziAWpdcC96xracZ16qtTWD6xeBFyM9s-BpHqPfo4Te1a9xlyT3-tlF2qtgUMJSnGN-Ipe21w2pm6mngKL0o1umeyrgz-CXMrGW_sDHUK1D7RqzmZzvh8ZVUBI8bB9os2QFxDypdZfv2qJSTyydJBOM_GDYG_cJ7jcaxonNmSGBDIZTXRlgtzqI3bw43e_NrULuCE2XBj4-nFaNMnEsUfFvSW35po1cLRcDPHoTCUaIdQBU6w0VsuRizMuX7o7y_Nngoc66XNg6XnPtgN0JyQqkyPUPYRRe5pNv7X_9KINtxCitkq5-9PsIIta74GfSehldSJpdI3pi_AhTBHPxtw8caBrySB4PiA7uLC8a3smdYm_cPPeSmsCGRgotRDxooo-FA2hOtCZ52PmlMzjdjmk5719WA_afK9D4MxGt8EmNonI9939XWprUNW2dTc7nQ7asjMo3BonGpP1LfbMIhZ7goD0rGtWNEqIdRifShaFffcKaKcmHtbBeOLWfnUm1PQ-0P0RGHCOh8jMJROn56KjB8djDKHKrvKKjvhVff-P91L_nNVOlqU0GWmWfwhSR279HOtsiQnHVFjnS9Qn0bAjpgf33caLTKebYH6CoUnorCkRHbh44gONFi2rQhOFH_fNKr_Wx6eRlrSj7LZIx20pgSG1RCi4QlVW6fv4Kkk-omRkRwmLrbpdqleoisRMBeyEAKRWk86M2VEyRwIGWakBQbSTkOTb5RENDxwz_VFwcqPkgpuIJzpOoG2p3YhLeqKgEAX5SAA\",\"Ctx\":\"rQQIARAAlVM_rNtEHH5-eQ19iFdQxQITlTohNe_OjtvmQUvjxI7jFzuJ_9tDke1z8P8zthMnGTt1QpW6IbEgxNCxU9XpsXZAFQygjkwsSNCpI46eSiW2fsN3p7vvvt_d6ft92oIdeHIVnMO7tuNz8l7PXqO4_O4H3dnVn27_cJf_Tv3494u3u48fETCoqrw8OT52PA8vs6rjeFW48lFY-F6Fi02nDjOE69LZLgu_4-H0-AlBPCeIPwni0f4VeJ2mAN27AUHHD7FIYjh2y_7SO53Lk6FUreoX--9P-8sqIHeEi3Drv9w_XOAi_TLHZfVt65eDae5nYzTAWdYU7OxkflaFnlOFOJsVOPeLKvTLW_15v8F4R8IkExJ7lGxsQwJf1xxGvFx7W7yakFxkkT3oZvOl1ew5pv2fzqUEepKh3E3lFaKkpoi-sRU6ckmwskymdkdJZJly7pL0dkK98UejXmobcuKlHGjGwOOZ0jGkAI2SlRvSgUcx3Rno1bYpnK9FUHQMumi0qmOgpWJ00__5C_YQJhLJrkVVDsUBqKXoK2qizqE9YitLTSJ7AGhbtWp7aG3EVIhENfZVikncOInnZG_ppnqEBvTQJeVkkry5q24Ked3ncknnZvZwTJmwRyN-Dnx2zaNEMjUgBCZIFs15WuN6Y2Wrx1rEUiJkMlXXZ_MUGSpLQ9FAhpfWXZTStk6i0gE24xqcLupspUNOUVR5qIIxcGMp1kA-mPLc1tM5Rlb7azEOVlImF1Mt3vp6482zW1XDUB2tTzUFxo4GIztBoQP0yjVtSklRYRmwMIGwsMB6MM-CBTLygToSKIVPplOegSLFGZpqF3LzVjHRFTkWu7qOlCkrK82_VBIMxlaiizaLIpPsPm61m5ymOHvWutTkJwvRJ3mBF2Hi_9H6CKVO4eGq8u-UvtdEusZFXO5y_fyAeHVAfH-h6ZLffvzwn4eff3bn4eLo3rXelb1nF44nqAzimyMLlxq8Xhr0jQimclY4mInJGZLcmXczq91TU3LFW9QJfNAmHrTbf7f3779DPD18-x67997Rxb3Lh4fK5ov75ckL_uxo79WlX5-enT35-Zu_-H8B0\",\"SessionId\":\"21036f6c-f348-4396-ae7b-2afaf476eb29\",\"CorrelationId\":\"c1245034-a43e-485e-9d54-1ad8083e34b2\",\"Timestamp\":\"2022-05-20T15:15:11Z\",\"Entropy\":88}")
	var mfaResp mfaResponse

	if err := json.Unmarshal(mfaBeginJsonWithEntropy, &mfaResp); err != nil {
		logrus.Error("Found an error while unmarshalling")
		t.Fail()
	}

	if mfaResp.Entropy != 88 {
		t.Errorf("Entropy is %d and should have been 88", mfaResp.Entropy)
	}
}

func TestAad_UnmarshallMfaResponseWithoutEntropy(t *testing.T) {

	mfaBeginJsonWithEntropy := []byte("{\"Success\":true,\"ResultValue\":\"Success\",\"Message\":null,\"AuthMethodId\":\"PhoneAppNotification\",\"ErrCode\":0,\"Retry\":false,\"FlowToken\":\"AQABAAEAAAD--DLA3VO7QrddgJg7Wevr5BtzS6C3muY2iOn2W5Nxhyz_B2nFLqOhdxngHgZWDXZHBx6mK27MN6N26J1oz7ydOnsuY3EfEWr5SHToI1N-NpdxotuKfqh6ssxejlKzEaCeYZ1AymWu3DENP9TEo0Pxnd6Vbd7H7soUMjW2-m2ykU1R7bCqcIQiGCF9NX2wmRVm5ia2SzPy1J3rU9nAKnppmiJoyT0yP-U24Jsty7Dje52s-ddFHkjtupiV-R3_JMx4c2KDAfJYabwAWy1Ra1UsxZbSwMkRwhacS46Y9pmztFuSeF6_opIV2H6xNogk2usNnFqJLqT-ibgy2qkJvot07XGH0leN7n-C2oLnziAWpdcC96xracZ16qtTWD6xeBFyM9s-BpHqPfo4Te1a9xlyT3-tlF2qtgUMJSnGN-Ipe21w2pm6mngKL0o1umeyrgz-CXMrGW_sDHUK1D7RqzmZzvh8ZVUBI8bB9os2QFxDypdZfv2qJSTyydJBOM_GDYG_cJ7jcaxonNmSGBDIZTXRlgtzqI3bw43e_NrULuCE2XBj4-nFaNMnEsUfFvSW35po1cLRcDPHoTCUaIdQBU6w0VsuRizMuX7o7y_Nngoc66XNg6XnPtgN0JyQqkyPUPYRRe5pNv7X_9KINtxCitkq5-9PsIIta74GfSehldSJpdI3pi_AhTBHPxtw8caBrySB4PiA7uLC8a3smdYm_cPPeSmsCGRgotRDxooo-FA2hOtCZ52PmlMzjdjmk5719WA_afK9D4MxGt8EmNonI9939XWprUNW2dTc7nQ7asjMo3BonGpP1LfbMIhZ7goD0rGtWNEqIdRifShaFffcKaKcmHtbBeOLWfnUm1PQ-0P0RGHCOh8jMJROn56KjB8djDKHKrvKKjvhVff-P91L_nNVOlqU0GWmWfwhSR279HOtsiQnHVFjnS9Qn0bAjpgf33caLTKebYH6CoUnorCkRHbh44gONFi2rQhOFH_fNKr_Wx6eRlrSj7LZIx20pgSG1RCi4QlVW6fv4Kkk-omRkRwmLrbpdqleoisRMBeyEAKRWk86M2VEyRwIGWakBQbSTkOTb5RENDxwz_VFwcqPkgpuIJzpOoG2p3YhLeqKgEAX5SAA\",\"Ctx\":\"rQQIARAAlVM_rNtEHH5-eQ19iFdQxQITlTohNe_OjtvmQUvjxI7jFzuJ_9tDke1z8P8zthMnGTt1QpW6IbEgxNCxU9XpsXZAFQygjkwsSNCpI46eSiW2fsN3p7vvvt_d6ft92oIdeHIVnMO7tuNz8l7PXqO4_O4H3dnVn27_cJf_Tv3494u3u48fETCoqrw8OT52PA8vs6rjeFW48lFY-F6Fi02nDjOE69LZLgu_4-H0-AlBPCeIPwni0f4VeJ2mAN27AUHHD7FIYjh2y_7SO53Lk6FUreoX--9P-8sqIHeEi3Drv9w_XOAi_TLHZfVt65eDae5nYzTAWdYU7OxkflaFnlOFOJsVOPeLKvTLW_15v8F4R8IkExJ7lGxsQwJf1xxGvFx7W7yakFxkkT3oZvOl1ew5pv2fzqUEepKh3E3lFaKkpoi-sRU6ckmwskymdkdJZJly7pL0dkK98UejXmobcuKlHGjGwOOZ0jGkAI2SlRvSgUcx3Rno1bYpnK9FUHQMumi0qmOgpWJ00__5C_YQJhLJrkVVDsUBqKXoK2qizqE9YitLTSJ7AGhbtWp7aG3EVIhENfZVikncOInnZG_ppnqEBvTQJeVkkry5q24Ked3ncknnZvZwTJmwRyN-Dnx2zaNEMjUgBCZIFs15WuN6Y2Wrx1rEUiJkMlXXZ_MUGSpLQ9FAhpfWXZTStk6i0gE24xqcLupspUNOUVR5qIIxcGMp1kA-mPLc1tM5Rlb7azEOVlImF1Mt3vp6482zW1XDUB2tTzUFxo4GIztBoQP0yjVtSklRYRmwMIGwsMB6MM-CBTLygToSKIVPplOegSLFGZpqF3LzVjHRFTkWu7qOlCkrK82_VBIMxlaiizaLIpPsPm61m5ymOHvWutTkJwvRJ3mBF2Hi_9H6CKVO4eGq8u-UvtdEusZFXO5y_fyAeHVAfH-h6ZLffvzwn4eff3bn4eLo3rXelb1nF44nqAzimyMLlxq8Xhr0jQimclY4mInJGZLcmXczq91TU3LFW9QJfNAmHrTbf7f3779DPD18-x67997Rxb3Lh4fK5ov75ckL_uxo79WlX5-enT35-Zu_-H8B0\",\"SessionId\":\"21036f6c-f348-4396-ae7b-2afaf476eb29\",\"CorrelationId\":\"c1245034-a43e-485e-9d54-1ad8083e34b2\",\"Timestamp\":\"2022-05-20T15:15:11Z\"}")
	var mfaResp mfaResponse

	if err := json.Unmarshal(mfaBeginJsonWithEntropy, &mfaResp); err != nil {
		logrus.Error("Found an error while unmarshalling")
		t.Fail()
	}

	if mfaResp.Entropy != 0 {
		t.Errorf("Entropy is %d and should have been 0", mfaResp.Entropy)
	}
}
